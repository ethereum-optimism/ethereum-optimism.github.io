version: 2.1

orbs:
  node: circleci/node@5.1.0
  gcp-cli: circleci/gcp-cli@3.0.1
  utils: ethereum-optimism/circleci-utils@dev:first

parameters:
  run_job:
    type: enum
    default: "select_job"
    enum:
      [
        "select_job",
        "generate-token-list"
      ]

commands:
  setup-node-env:
    parameters:
      node_version:
        type: string
        default: "16.x"
      pnpm_version:
        type: string
        default: "8.6.0"
    steps:
      - run:
          name: Install pnpm
          command: |
            npm install -g pnpm@<< parameters.pnpm_version >>
      - run:
          name: Install dependencies
          command: pnpm install --frozen-lockfile

jobs:
  generate-token-list:
    machine:
      image: ubuntu-2204:2024.08.1
    steps:
      - checkout
      - setup-node-env
      - run:
          name: Update version and generate token list
          command: |
            # Patch version and generate token list
            npm version patch
            pnpm generate:ci
      - run:
          name: Check if push to branch run by a non github user
          command: |

            # skip commit if push to branch run by a non github user
            PERFORM_COMMIT="true"
            if [ -z "$CIRCLE_USERNAME" ]; then
              echo "CIRCLE_USERNAME is not set"
              export PERFORM_COMMIT="false"
            fi
            echo "export PERFORM_COMMIT=$PERFORM_COMMIT" >> $BASH_ENV

            # skip commit if there are no differences in optimism.tokenlist.json
            if [ -z "$(git diff optimism.tokenlist.json)" ]; then
              echo "No changes detected in optimism.tokenlist.json"
              export PERFORM_COMMIT="false"
            fi

            echo "export PERFORM_COMMIT=$PERFORM_COMMIT" >> $BASH_ENV

      - utils/github-commit-and-push-changes-single-file:
          commit-username: "mergify[bot]"
          commit-email: "mergify[bot]@users.noreply.github.com"
          commit-message: "bot(ci): generate token list"
          skip-ci: true
          file: "optimism.tokenlist.json"
          condition: "$PERFORM_COMMIT" # will skip if push to branch run by a non github user


workflows:
  version: 2
  generate-token-list-workflow:
  #   # when:
  #   #
  #   #   or:
  #   #     - equal: [<< pipeline.parameters.run_job >>, "generate-token-list"]
  #   #     - and:
  #   #         - equal: [<< pipeline.git.branch >>, "master"]
  #   #         - not:
  #   #             equal: [<< pipeline.trigger_source >>, "api"]
    jobs:
      - generate-token-list:
          context: circleci-repo-ethereum-optimism.github.io
  #         # filters:
  #         #   branches:
  #         #     only: master